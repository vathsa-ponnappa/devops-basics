pipeline {
  agent any

  environment {
    REPO_SSH = 'git@github.com:vathsa-ponnappa/devops-basics.git'
    BRANCH = 'main'
  }

  stages {
    stage('Checkout') {
      steps {
        echo "-> Checking out ${env.REPO_SSH} (branch: ${env.BRANCH})"
        git url: "${env.REPO_SSH}", branch: "${env.BRANCH}"
        dir('sample-app') { echo "Inside sample-app directory" }
      }
    }

    stage('Build') {
      steps {
        dir('sample-app') {
          echo 'Building the Python sample app...'
          script {
            if (isUnix()) {
              sh '''
                if command -v python >/dev/null 2>&1; then
                  python --version
                elif command -v python3 >/dev/null 2>&1; then
                  python3 --version
                else
                  echo "Python not found on PATH. Skipping build and tests."
                  exit 0
                fi
              '''
            } else {
              bat '''
                where python >nul 2>&1 && (python --version) || (where py >nul 2>&1 && py -3 --version) || (echo Python not found on PATH. Skipping build and tests. & exit /b 0)
              '''
            }
          }
        }
      }
    }

    stage('Test') {
      steps {
        dir('sample-app') {
          echo 'Running tests (if pytest installed)...'
          script {
            if (isUnix()) {
              sh '''
                # detect python
                if command -v python >/dev/null 2>&1; then PY=python
                elif command -v python3 >/dev/null 2>&1; then PY=python3
                else
                  echo "No python found, skipping tests"
                  exit 0
                fi

                $PY --version
                $PY -m pip install --upgrade pip || true
                $PY -m pip install -r requirements.txt || echo "pip install returned non-zero"
                $PY -m pytest || rc=$?
                rc=${rc:-$?}
                if [ "$rc" -eq 5 ]; then
                  echo "No tests collected (pytest exit code 5). Treating as success."
                  exit 0
                elif [ "$rc" -ne 0 ]; then
                  echo "pytest failed with exit code $rc"
                  exit $rc
                fi
              '''
            } else {
              // Windows - linear, safe flow
              bat '''
                REM Try 'python' first, fallback to 'py -3'
                where python >nul 2>&1
                if %ERRORLEVEL% EQU 0 (
                  python -m pip install --upgrade pip
                  python -m pip install -r requirements.txt || echo pip install returned non-zero
                  python -m pytest
                ) else (
                  where py >nul 2>&1
                  if %ERRORLEVEL% EQU 0 (
                    py -3 -m pip install --upgrade pip
                    py -3 -m pip install -r requirements.txt || echo pip install returned non-zero
                    py -3 -m pytest
                  ) else (
                    echo No python launcher found, skipping tests
                    REM ensure ERRORLEVEL = 0
                    exit /b 0
                  )
                )

                REM capture final ERRORLEVEL
                set rc=%ERRORLEVEL%
                if "%rc%"=="" set rc=0

                REM if no tests collected (pytest exit code 5) -> treat as success
                if %rc% EQU 5 (
                  echo No tests collected (pytest exit code 5). Treating as success.
                  exit /b 0
                )

                REM if other non-zero -> fail
                if %rc% NEQ 0 (
                  echo pytest failed with exit code %rc%.
                  exit /b %rc%
                )

                REM otherwise continue
              '''
            }
          }
        }
      }
    }

    stage('Deploy') {
      when { expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' } }
      steps {
        dir('sample-app') {
          echo 'Simulating deployment...'
          script {
            if (isUnix()) {
              sh 'echo "Deployment simulated: success"'
            } else {
              bat 'echo Deployment simulated: success'
            }
          }
        }
      }
    }
  }

  post {
    success { echo '‚úÖ Pipeline finished successfully!' }
    unstable { echo '‚ö†Ô∏è Pipeline unstable (tests may have issues).' }
    failure { echo '‚ùå Pipeline failed! Check console logs.' }
    always {
      archiveArtifacts artifacts: 'sample-app/**', allowEmptyArchive: true
      echo 'üì¶ Post actions completed (artifacts archived if present).'
    }
  }
}
