pipeline {
    agent any

    environment {
        REPO_URL = 'https://github.com/vathsa-ponnappa/devops-basics.git'
        APP_DIR = 'devops-pipeline-trigger'
        IMAGE_NAME = 'devops-pipeline-trigger'
        DOCKERHUB_USER = 'vathsalingeriponnappa'
    }

    triggers {
        githubPush()  // Automatically build on push
    }

    stages {

        stage('Clone Repository') {
            steps {
                echo 'üì¶ Cloning latest from GitHub...'
                deleteDir()
                git branch: 'main', url: "${REPO_URL}"
                bat 'git log -1 --pretty=format:"‚úÖ Building commit: %h - %s"'
            }
        }

        stage('Set Version') {
            steps {
                script {
                    // Properly define the variable to avoid memory leak warning
                    def buildNum = env.BUILD_NUMBER
                    env.BUILD_VERSION = "v${buildNum}"
                    echo "üöÄ Build Version: ${env.BUILD_VERSION}"
                }
            }
        }

        stage('Build Docker Image in WSL') {
            steps {
                echo "üê≥ Building Docker image: ${DOCKERHUB_USER}/${IMAGE_NAME}:${env.BUILD_VERSION}"

                // Use CMD‚Äôs caret escaping to safely pass to WSL Bash
                bat '''
                wsl -d Ubuntu bash -c "cd /home/vathsaponnappa/devops-basics/devops-pipeline-trigger && \
                docker build --progress=plain -t vathsalingeriponnappa/devops-pipeline-trigger:%BUILD_VERSION% \
                -t vathsalingeriponnappa/devops-pipeline-trigger:latest ."
                '''
            }
        }

        stage('Run Docker Container') {
            steps {
                echo "üöÄ Running Flask container..."
                bat '''
                wsl -d Ubuntu bash -c "docker stop devops-pipeline-trigger || true && \
                docker rm devops-pipeline-trigger || true && \
                docker run -d -p 5000:5000 --name devops-pipeline-trigger \
                vathsalingeriponnappa/devops-pipeline-trigger:%BUILD_VERSION%"
                '''
            }
        }

        stage('Push to Docker Hub') {
            steps {
                echo "üì§ Pushing ${env.BUILD_VERSION} to Docker Hub..."
                withCredentials([usernamePassword(credentialsId: 'dockerhub',
                                                 usernameVariable: 'DOCKER_USER',
                                                 passwordVariable: 'DOCKER_PASS')]) {
                    // Safely login & push using CMD variable expansion (%VAR%)
                    bat '''
                    wsl -d Ubuntu bash -c "echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin && \
                    docker push %DOCKER_USER%/devops-pipeline-trigger:%BUILD_VERSION% && \
                    docker push %DOCKER_USER%/devops-pipeline-trigger:latest"
                    '''
                }
            }
        }

        stage('Cleanup Old Images') {
            steps {
                echo 'üßπ Cleaning up unused Docker images...'
                bat 'wsl -d Ubuntu bash -c "docker image prune -f"'
            }
        }

        stage('Verify Deployment') {
            steps {
                echo 'üß† Checking running containers...'
                bat 'wsl -d Ubuntu bash -c "docker ps"'
            }
        }
    }

    post {
        success {
            echo "‚úÖ Build ${env.BUILD_VERSION} succeeded!"
            echo "üì¶ Image pushed to Docker Hub: ${DOCKERHUB_USER}/${IMAGE_NAME}:${env.BUILD_VERSION}"
            echo "üåê Flask app running at: http://localhost:5000"
        }
        failure {
            echo "‚ùå Build ${env.BUILD_VERSION} failed. Check Jenkins logs."
        }
    }
}
