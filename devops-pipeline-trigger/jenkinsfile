pipeline {
  agent any

  environment {
    DOCKER_USER = "vathsalingeriponnappa"
    IMAGE_NAME  = "devops-pipeline-trigger"
    BUILD_VERSION = "v${BUILD_NUMBER}"
  }

  triggers {
    githubPush()  // üî• This enables automatic builds when you push to GitHub
  }

  stages {
    stage('Clone Repository') {
      steps {
        echo "üì¶ Pulling latest code..."
        deleteDir()
        git url: 'https://github.com/vathsa-ponnappa/devops-basics.git', branch: 'main'
      }
    }

    stage('Build Docker Image') {
      steps {
        echo "üê≥ Building image..."
        bat """
        wsl -d Ubuntu -- bash -c "cd /home/vathsaponnappa/devops-basics/devops-pipeline-trigger && \
        docker build -t ${DOCKER_USER}/${IMAGE_NAME}:${BUILD_VERSION} -t ${DOCKER_USER}/${IMAGE_NAME}:latest ."
        """
      }
    }

    stage('Push to Docker Hub') {
      steps {
        echo "üì§ Pushing to Docker Hub..."
        withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          bat """
          wsl -d Ubuntu -- bash -lc "echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin && \
          docker push ${DOCKER_USER}/${IMAGE_NAME}:${BUILD_VERSION} && \
          docker push ${DOCKER_USER}/${IMAGE_NAME}:latest"
          """
        }
      }
    }
stage('Push to Docker Hub') {
  steps {
    echo "üì§ Pushing ${BUILD_VERSION} to Docker Hub..."
    withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
      // Use a triple-single-quoted bat script so Groovy does NOT interpolate $DOCKER_PASS.
      // Inside we rely on Windows CMD to expand %DOCKER_PASS% and pass it into WSL.
      bat '''
        wsl -d Ubuntu -- bash -lc "echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin && \
        docker push %DOCKER_USER%/''' + "${IMAGE_NAME}" + ''':${BUILD_VERSION} && \
        docker push %DOCKER_USER%/''' + "${IMAGE_NAME}" + ''':latest"
      '''
    }
  }
}

    stage('Verify Deployment') {
      steps {
        echo "üß† Checking running containers..."
        bat 'wsl -d Ubuntu -- bash -c "docker ps"'
      }
    }
  }

  post {
    success {
      echo "‚úÖ Trigger Build Successful ‚Äî ${BUILD_VERSION} pushed to Docker Hub!"
    }
    failure {
      echo "‚ùå Trigger Build Failed ‚Äî check logs."
    }
  }
}
